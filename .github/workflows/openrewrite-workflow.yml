name: 'OpenRewrite Workflow'

on:
  workflow_call:
    inputs:
      recipes:
        description: 'Comma-separated OpenRewrite recipes to activate.'
        type: string
        required: true
      recipe-parameters:
        description: 'Comma-separated key=value pairs for recipe parameters in namespaced format. Format: "recipeName.parameterName=value". Example: "com.example.CreateFile.targetDirectory=kubernetes/instance-1"'
        type: string
        required: false
      recipes-dir:
        description: 'Directory containing recipe YAML files (default: recipes)'
        type: string
        required: false
        default: 'recipes'
      rewrite-dependencies:
        description: 'Comma-separated list of OpenRewrite dependencies (e.g., org.openrewrite:rewrite-yaml:8.37.1,org.openrewrite:rewrite-json:8.37.0)'
        type: string
        required: false
      java-version:
        description: 'Java version to use (default: 17)'
        type: string
        required: false
        default: '17'
      gradle-version:
        description: 'Gradle version to use (default: 9.2.0)'
        type: string
        required: false
        default: '9.2.0'
      openrewrite-version:
        description: 'OpenRewrite plugin version to use (default: 7.20.0)'
        type: string
        required: false
        default: '7.20.0'

jobs:
  openrewrite:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run OpenRewrite
        id: openrewrite
        uses: rhart/openrewrite-workflow/.github/actions/openrewrite-runner@rhart/debug
        with:
          recipes: ${{ inputs.recipes }}
          recipe-parameters: ${{ inputs.recipe-parameters }}
          recipes-dir: ${{ inputs.recipes-dir }}
          rewrite-dependencies: ${{ inputs.rewrite-dependencies }}
          java-version: ${{ inputs.java-version }}
          gradle-version: ${{ inputs.gradle-version }}
          openrewrite-version: ${{ inputs.openrewrite-version }}

      - name: Create Pull Request
        if: steps.openrewrite.outputs.changes-detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: Apply OpenRewrite recipes ${{ inputs.recipes }}'
          title: 'OpenRewrite: Apply recipes ${{ inputs.recipes }}'
          body: |
            This PR was automatically generated by OpenRewrite.

            **Recipes applied:** `${{ steps.openrewrite.outputs.activated-recipes }}`

            Please review the changes carefully before merging.

            ---
            ü§ñ Generated by [OpenRewrite Reusable Workflow](https://github.com/${{ github.repository }})
          branch: openrewrite-auto-pr
          delete-branch: true
          labels: automated,openrewrite

      - name: No changes detected
        if: steps.openrewrite.outputs.changes-detected == 'false'
        run: |
          echo "‚ÑπÔ∏è  No changes were made by OpenRewrite. Nothing to commit."
