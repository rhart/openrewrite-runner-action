name: Test OpenRewrite Runner

on:
  workflow_dispatch:
    inputs:
      recipes:
        description: 'Comma-separated list of recipe names'
        required: true
        default: 'com.example.FixKubernetesManifests'
      recipe-parameters:
        description: 'Recipe parameters (recipeName.paramName=value)'
        required: false
        default: 'com.example.FixKubernetesManifests.targetDirectory=examples/yaml/project-*'

jobs:
  test-action:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run OpenRewrite
        id: openrewrite
        uses: ./
        with:
          recipes: ${{ github.event.inputs.recipes }}
          recipe-parameters: ${{ github.event.inputs.recipe-parameters }}
          recipes-dir: "examples/recipes"
          rewrite-dependencies: "org.openrewrite:rewrite-yaml:8.66.3"

      - name: Show results
        run: |
          echo "Changes detected: ${{ steps.openrewrite.outputs.changes-detected }}"
          echo "Activated recipes: ${{ steps.openrewrite.outputs.activated-recipes }}"
          if [[ "${{ steps.openrewrite.outputs.changes-detected }}" == "true" ]]; then
            echo "Files changed:"
            git status --short
          fi
